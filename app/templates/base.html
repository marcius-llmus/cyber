<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama Coding - AI Development Assistant</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/static/css/app.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js" integrity="sha384-/TgkGk7p307TH7EXJDuUlgG3Ce1UVolAOFopFekQkkXihi5u/6OCvVKyz1W+idaz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/htmx-ext-ws@2.0.4" integrity="sha384-1RwI/nvUSrMRuNj7hX1+27J8XDdCoSLf0EjEyF69nacuWyiJYoQ/j39RT1mSnd2G" crossorigin="anonymous"></script>
    <script src="/static/js/htmx-ext-form-json.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.1/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="/static/js/highlight.min.js"></script>
    <!-- Highlight Theme Link (ID required for dynamic switching) -->
    <link id="highlight-theme-link" rel="stylesheet" href="/static/css/highlight/atom-one-dark.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': 'var(--color-primary)',
                        'primary-dark': 'var(--color-primary-dark)',
                        'primary-light': 'var(--color-primary-light)',
                        'dark': 'var(--color-dark)',
                        'dark-lighter': 'var(--color-dark-lighter)',
                        'dark-light': 'var(--color-border)',
                        'dark-card': 'var(--color-dark-card)',
                        'dark-darker': 'var(--color-dark-darker)'
                    }
                }
            }
        }
    </script>
    <script>
        // Initialize Markdown Parser
        const md = window.markdownit({
            html: false,
            linkify: true,
            breaks: true,
            typographer: true,
            highlight: function (str, lang) {
                if (lang && window.hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(str, { language: lang }).value;
                    } catch (__) {}
                }
                return '';
            }
        });
        // Open links in new tab securely
        const defaultRender = md.renderer.rules.link_open || function(tokens, idx, options, env, self) {
            return self.renderToken(tokens, idx, options);
        };
        md.renderer.rules.link_open = function (tokens, idx, options, env, self) {
            tokens[idx].attrSet('target', '_blank');
            tokens[idx].attrSet('rel', 'noopener noreferrer');
            return defaultRender(tokens, idx, options, env, self);
        };
    </script>
    <script>
        // Anti-FOUC: Apply theme immediately
        (function() {
            const map = {
                'bgColor': '--color-dark', 'bgSecondaryColor': '--color-dark-lighter',
                'borderColor': '--color-border', 'scrollColor': '--color-scroll-thumb',
                'bgCardColor': '--color-dark-card', 'bgDarkerColor': '--color-dark-darker', 
                'textColor': '--color-text',
                'primaryColor': '--color-primary', 'primaryDarkColor': '--color-primary-dark',
                'primaryLightColor': '--color-primary-light'
            };
            const root = document.documentElement;
            Object.entries(map).forEach(([key, varName]) => {
                const val = localStorage.getItem(key);
                if (val) root.style.setProperty(varName, val);
            });
            // Font Sizes
            const uiSz = localStorage.getItem('uiFontSize');
            if (uiSz) root.style.setProperty('--fs-ui', uiSz + 'px');
            const edSz = localStorage.getItem('editorFontSize');
            if (edSz) root.style.setProperty('--fs-editor', edSz + 'px');
        })();
    </script>
    <style>
        body { font-family: var(--font-ui) !important; font-size: var(--fs-ui) !important; background-color: var(--color-dark) !important; color: var(--color-text) !important; }
        .text-gray-200, .text-gray-300, .text-gray-400 { color: var(--color-text) !important; }
        #message-list { font-size: var(--fs-editor) !important; }
        
        /* Adjust opacity for secondary text to keep hierarchy */
        .text-xs, .text-sm { opacity: 0.9; }
    </style>
</head>
<body class="bg-dark text-gray-200 h-screen flex" 
      hx-ext="ws" 
      ws-connect="/coder/ws/session/{{ session.id }}"
      x-data>
    
    <!-- Tailwind CSS Safelist -->
    <div class="hidden border-red-500 border-green-500 border-blue-500 border-yellow-500"></div>
    
    {% include "layout/sidebar.html" %}

    <main class="flex-1 flex overflow-hidden bg-dark">
        {% block content %}{% endblock %}

        {% include "layout/right_sidebar.html" %}
    </main>

    {% include "settings/settings_modal.html" %}
    {% include "settings/appearance_modal.html" %}
    {% include "projects/projects_modal.html" %}
    {% include "prompts/prompts_modal.html" %}
    {% include "history/history_modal.html" %}
    {% include "context/context_file_selection_modal.html" %}
    {% include "components/alerts/toast.html" %}
    <script src="/static/js/app.js"></script>
</body>
</html>