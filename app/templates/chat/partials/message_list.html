<div class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth break-words" id="message-list" :class="$store.appearance.editorFontSize">
    <!-- System welcome message -->
    <div class="flex items-start gap-3" id="ai-message-system">
        <div class="w-8 h-8 bg-primary rounded-md flex items-center justify-center flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
        </div>
        <div class="bg-dark-card rounded-lg p-4 flex-1 min-w-0">
            <div id="raw-system" class="hidden">Hello! How can I assist you today?</div>
            <div id="rendered-system" class="prose prose-invert text-gray-300 w-full max-w-none break-words">
                <!-- JS will render -->
            </div>
        </div>
    </div>
    {% for message in messages %}
        {% if message.role.value == 'user' %}
        <div class="flex items-start gap-3 justify-end" id="user-message-{{ message.id }}">
            <div class="flex justify-end">
                <div class="bg-dark-card rounded-lg p-4 max-w-full">
                    <div class="text-gray-200 text-sm">
                        {{ message.content }}
                    </div>
                </div>
            </div>
            <div class="w-8 h-8 bg-gray-600 rounded-md flex items-center justify-center flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </div>
        </div>
        {% elif message.role.value == 'assistant' %}
        <div class="flex items-start gap-3" id="ai-message-{{ message.id }}">
            <div class="w-8 h-8 bg-primary rounded-md flex items-center justify-center flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <div class="bg-dark-card rounded-lg p-4 flex-1 min-w-0">
                <!-- Hidden Buffer -->
                <div id="raw-{{ message.id }}" class="hidden">{{ message.content }}</div>
                
                <!-- Visible Render Target -->
                <div id="rendered-{{ message.id }}" class="prose prose-invert text-gray-300 max-w-none break-words">
                    <!-- Initial content will be rendered by JS on load -->
                </div>
                
                <div class="flex items-center justify-end pt-2 mt-2" id="controls-{{ message.id }}">
                    <div class="flex space-x-2 text-xs text-gray-500">
                        {% if message.cost %}
                        <span class="cost-badge text-primary" title="Output tokens: {{ message.output_tokens }}">
                            <i class="fas fa-dollar-sign"></i> {{ "%.4f"|format(message.cost) }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>