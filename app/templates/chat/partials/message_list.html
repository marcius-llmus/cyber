<div class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth break-words" id="message-list">
    <!-- System welcome message -->
    <div class="flex items-start gap-3" id="ai-message-system">
        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
            {% include "components/icons/ai_avatar.html" %}
        </div>
        <div class="bg-dark-card rounded-lg p-4 flex-1 min-w-0">
            <div id="raw-system" class="hidden">Hello! How can I assist you today?</div>
            <div id="rendered-system" class="prose prose-invert text-gray-300 w-full max-w-none break-words">
                <!-- JS will render -->
            </div>
        </div>
    </div>
    {% for message in messages %}
        {% if message.role.value == 'user' %}
        <div class="flex items-start gap-3" id="user-message-{{ message.id }}">
            <div class="bg-dark-card rounded-lg p-4 flex-1 min-w-0">
                <div class="text-gray-200 text-sm whitespace-pre-wrap">{{ message.content }}</div>
                <div id="user-message-controls-{{ message.id }}"></div>
            </div>
            <div class="w-8 h-8 bg-dark-light rounded-lg flex items-center justify-center flex-shrink-0">
                {% include "components/icons/user_avatar.html" %}
            </div>
        </div>
        {% elif message.role.value == 'assistant' %}
        <div class="flex items-start gap-3" id="ai-message-{{ message.id }}">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                {% include "components/icons/ai_avatar.html" %}
            </div>
            <div class="bg-dark-card rounded-lg p-4 flex-1 min-w-0">
                <!-- Hidden Buffer -->
                <div id="raw-{{ message.id }}" class="hidden">{{ message.content }}</div>
                
                <!-- Visible Render Target -->
                <div id="rendered-{{ message.id }}" class="prose prose-invert text-gray-300 max-w-none break-words">
                    <!-- Initial content will be rendered by JS on load -->
                </div>
                
                <div class="flex items-center justify-end {% if message.cost %}pt-2 mt-2{% endif %}" id="controls-{{ message.id }}">
                    <div class="flex space-x-2 text-xs text-gray-500">
                        {% if message.cost %}
                        <span class="cost-badge text-primary" title="Output tokens: {{ message.output_tokens }}">
                            <i class="fas fa-dollar-sign"></i> {{ "%.4f"|format(message.cost) }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>