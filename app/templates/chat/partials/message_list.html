<div class="flex-1 overflow-y-auto p-4 pb-10 space-y-5 scroll-smooth break-words" id="message-list">
    <!-- System welcome message -->
    <div class="flex items-start gap-3" id="ai-message-system">
        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
            {% include "components/icons/ai_avatar.html" %}
        </div>
        <div class="bg-dark-card rounded-lg p-4 flex-1 min-w-0">
            <div id="raw-system" class="hidden markdown-source">Hello! How can I assist you today?</div>
            <div id="rendered-system" class="prose prose-invert text-gray-300 w-full max-w-none break-words">
                <!-- JS will render -->
            </div>
        </div>
    </div>
    {% for message in messages %}
        {% if message.role.value == 'user' %}
        <div class="flex items-start gap-3" id="user-message-{{ message.id }}">
            <div class="bg-dark-card rounded-lg p-4 flex-1 min-w-0">
                <!-- User Markdown Rendering -->
                <div id="raw-user-{{ message.id }}" class="hidden markdown-source">{{ message.content }}</div>
                <div id="rendered-user-{{ message.id }}" class="prose prose-invert text-gray-200 max-w-none break-words"></div>
                <div id="user-message-controls-{{ message.id }}"></div>
            </div>
            <div class="w-8 h-8 bg-dark-light rounded-lg flex items-center justify-center flex-shrink-0">
                {% include "components/icons/user_avatar.html" %}
            </div>
        </div>
        {% elif message.role.value == 'assistant' %}
        <div class="flex items-start gap-3" id="ai-message-{{ message.id }}">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                {% include "components/icons/ai_avatar.html" %}
            </div>
            <div class="bg-dark-card rounded-lg p-4 flex-1 min-w-0">
                <!-- Hidden Buffer -->
                <div id="raw-{{ message.id }}" class="hidden markdown-source">{{ message.content }}</div>
                
                <!-- Visible Render Target -->
                <div id="rendered-{{ message.id }}" class="prose prose-invert text-gray-300 max-w-none break-words">
                    <!-- Initial content will be rendered by JS on load -->
                </div>
                
                {% if message.tool_calls %}
                <div class="mt-4 border-t border-gray-700 pt-2">
                    <details class="group">
                        <summary class="cursor-pointer text-xs font-mono text-gray-500 hover:text-gray-300 flex items-center gap-2 select-none">
                            <i class="fas fa-terminal"></i>
                            <span>Tool Calls ({{ message.tool_calls|length }})</span>
                            <span class="ml-auto group-open:rotate-180 transition-transform duration-200">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                        </summary>
                        <div class="mt-2 space-y-2 pl-2 border-l-2 border-gray-700">
                            {% for tool in message.tool_calls %}
                            {% if tool.name != 'apply_diff' %}
                            <div class="bg-gray-900 rounded p-2 text-xs font-mono overflow-x-auto">
                                <div class="text-primary font-bold mb-1">{{ tool.name }}</div>
                                <pre class="text-gray-400 whitespace-pre-wrap">{{ tool.kwargs | tojson(indent=2) }}</pre>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </details>
                </div>
                {% endif %}

                {% if message.diff_patches %}
                <div class="mt-2 border-t border-gray-700 pt-2">
                    <details class="group">
                        <summary class="cursor-pointer text-xs font-mono text-gray-500 hover:text-gray-300 flex items-center gap-2 select-none">
                            <i class="fas fa-code-branch"></i>
                            <span>Applied Patches ({{ message.diff_patches|length }})</span>
                            <span class="ml-auto group-open:rotate-180 transition-transform duration-200">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                        </summary>
                        <div class="mt-2 space-y-2 pl-2 border-l-2 border-gray-700">
                            {% for patch in message.diff_patches %}
                            <div class="bg-gray-900 rounded p-2 text-xs font-mono overflow-x-auto">
                                <div class="text-green-500 font-bold mb-1">{{ patch.file_path }}</div>
                                <pre class="text-gray-400"><code class="language-diff">{{ patch.diff }}</code></pre>
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                </div>
                {% endif %}

                <div class="flex items-center justify-end {% if message.cost %}pt-2 mt-2{% endif %}" id="controls-{{ message.id }}">
                    <div class="flex space-x-2 text-xs text-gray-500">
                        {% if message.cost %}
                        <span class="cost-badge text-primary" title="Output tokens: {{ message.output_tokens }}">
                            <i class="fas fa-dollar-sign"></i> {{ "%.4f"|format(message.cost) }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>